name: Release Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: "Publish to PyPI (requires PYPI_API_TOKEN secret)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: read

jobs:
  build-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect project directory
        id: detect_project
        shell: bash
        run: |
          if [[ -f "pyproject.toml" && -d "tests" ]]; then
            echo "project_dir=." >> "$GITHUB_OUTPUT"
          elif [[ -f "enterprise_bot/pyproject.toml" && -d "enterprise_bot/tests" ]]; then
            echo "project_dir=enterprise_bot" >> "$GITHUB_OUTPUT"
          else
            echo "Could not find project root with pyproject.toml and tests/"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel and sdist
        working-directory: ${{ steps.detect_project.outputs.project_dir }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build

      - name: Upload Python dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: ${{ steps.detect_project.outputs.project_dir }}/dist/*
          if-no-files-found: error

  build-windows-installer:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect project directory
        id: detect_project
        shell: bash
        run: |
          if [[ -f "pyproject.toml" && -d "tests" ]]; then
            echo "project_dir=." >> "$GITHUB_OUTPUT"
          elif [[ -f "enterprise_bot/pyproject.toml" && -d "enterprise_bot/tests" ]]; then
            echo "project_dir=enterprise_bot" >> "$GITHUB_OUTPUT"
          else
            echo "Could not find project root with pyproject.toml and tests/"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build setup.exe
        shell: pwsh
        working-directory: ${{ steps.detect_project.outputs.project_dir }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
          python -m pip install -e ".[gui]"
          powershell -NoProfile -ExecutionPolicy Bypass -File installer\build_setup.ps1

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: ${{ steps.detect_project.outputs.project_dir }}/dist/setup.exe
          if-no-files-found: error

  create-github-release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs:
      - build-python
      - build-windows-installer
    permissions:
      contents: write
    steps:
      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create GitHub Release and upload files
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-artifacts/python-dist/*
            release-artifacts/windows-installer/*

  publish-pypi:
    if: >
      secrets.PYPI_API_TOKEN != '' &&
      (startsWith(github.ref, 'refs/tags/') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_pypi == 'true'))
    runs-on: ubuntu-latest
    needs:
      - build-python
    steps:
      - name: Download Python dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist
